app-id: org.getmonero.Monero
runtime: org.kde.Platform
runtime-version: 5.15-22.08
sdk: org.kde.Sdk
finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=all
  - --filesystem=~/Monero:create
  - --persist=.bitmonero

cleanup:
  - /include
  - /etc
  - /share/man
  - /lib/pkgconfig
  - /lib/cmake
  - '*.a'
  - '*.la'

command: monero-wallet-gui
modules:
  - name: monero-gui
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DWITH_DESKTOP_ENTRY=OFF
      - -DWITH_UPDATER=OFF
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DARCH=armv8-a
            - -DBUILD_TAG=linux-armv8
        x86_64:
          config-opts:
            - -DARCH=default
    sources:
      - type: archive
        url: https://downloads.getmonero.org/gui/monero-gui-source-v0.18.2.2.tar.bz2
        sha256: 58ced28d3eecda0c47f51003ae65b5bdf076ef60bdb25614421a07ef2e0791a4
        x-checker-data:
          type: json
          url: https://api.github.com/repos/monero-project/monero-gui/releases/latest
          version-query: .tag_name
          url-query: '"https://downloads.getmonero.org/gui/monero-gui-source-" + $version
            + ".tar.bz2"'
    modules:
      - shared-modules/libusb/libusb.json

      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=$FLATPAK_DEST --with-libraries=chrono,date_time,filesystem,locale,program_options,regex,serialization,system,thread
          - ./b2 headers
          - ./b2 -j$FLATPAK_BUILDER_N_JOBS install variant=release --layout=system
        sources:
          - type: archive
            url: https://boostorg.jfrog.io/artifactory/main/release/1.79.0/source/boost_1_79_0.tar.gz
            sha256: 273f1be93238a068aba4f9735a4a2b003019af067b9c183ed227780b8f36062c

      - name: protobuf
        sources:
          - type: archive
            url: https://github.com/protocolbuffers/protobuf/releases/download/v21.3/protobuf-cpp-3.21.3.tar.gz
            sha256: c98a4f17ed57e9e4dafc4a52e76ee012f9a6a13750488b20b4c370a3eb1561fc

      - name: libunbound
        config-opts:
          - --with-libunbound-only
        sources:
          - type: archive
            url: https://nlnetlabs.nl/downloads/unbound/unbound-1.18.0.tar.gz
            sha256: 3da95490a85cff6420f26fae0b84a49f5112df1bf1b7fc34f8724f02082cb712
            x-checker-data:
              type: html
              url: https://nlnetlabs.nl/downloads/unbound/
              pattern: (unbound-([\d\.]+)\.tar\.gz)

      - name: libsodium
        sources:
          - type: archive
            url: https://github.com/jedisct1/libsodium/releases/download/1.0.19-RELEASE/libsodium-1.0.19.tar.gz
            sha256: 018d79fe0a045cca07331d37bd0cb57b2e838c51bc48fd837a1472e50068bbea
            x-checker-data:
              type: json
              url: https://api.github.com/repos/jedisct1/libsodium/releases/latest
              version-query: .name
              url-query: |
                .assets | map(select(.name=="libsodium-\($version).tar.gz")) | first | .browser_download_url

      - name: hidapi
        buildsystem: cmake
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: archive
            url: https://github.com/libusb/hidapi/archive/hidapi-0.12.0.tar.gz
            sha256: 28ec1451f0527ad40c1a4c92547966ffef96813528c8b184a665f03ecbb508bc

      - name: openpgm
        subdir: openpgm/pgm
        sources:
          - type: archive
            url: https://github.com/steve-o/openpgm/archive/release-5-3-128.tar.gz
            sha256: 8d707ef8dda45f4a7bc91016d7f2fed6a418637185d76c7ab30b306499c6d393
          - type: patch
            path: openpgm-fix-build.patch

      - name: libzmq
        config-opts:
          - --with-pgm
          - --with-libsodium
          - --disable-Werror
        sources:
          - type: archive
            url: https://github.com/zeromq/libzmq/releases/download/v4.3.4/zeromq-4.3.4.tar.gz
            sha256: c593001a89f5a85dd2ddf564805deb860e02471171b3f204944857336295c3e5

  - name: p2pool
    buildsystem: cmake
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DWITH_LTO=OFF
    sources:
      - type: git
        url: https://github.com/SChernykh/p2pool
        tag: v3.7
        commit: 2ed63ab3acad15bd794eec72e54a18c65a4bd0e2
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
    post-install:
      - install -Dm755 p2pool $FLATPAK_DEST/bin/p2pool
    modules:
      - name: libgss
        sources:
          - type: archive
            url: https://ftp.gnu.org/gnu/gss/gss-1.0.3.tar.gz
            sha256: ff919ddc731531d65e27d7ababdc361aae05ada5f1a6dd60703d153307dcdeeb

      - name: libuv
        buildsystem: cmake
        sources:
          - type: archive
            url: https://github.com/libuv/libuv/archive/v1.44.1.tar.gz
            sha256: e91614e6dc2dd0bfdd140ceace49438882206b7a6fb00b8750914e67a9ed6d6b

  - name: monero-extra
    buildsystem: simple
    build-commands:
      - install -Dpm644 org.getmonero.Monero.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -Dpm644 org.getmonero.Monero.svg $FLATPAK_DEST/share/icons/hicolor/scalable/apps/$FLATPAK_ID.svg
      - install -Dpm644 org.getmonero.Monero.metainfo.xml $FLATPAK_DEST/share/metainfo/$FLATPAK_ID.metainfo.xml
    sources:
      - type: file
        path: extra/org.getmonero.Monero.desktop
      - type: file
        path: extra/org.getmonero.Monero.svg
      - type: file
        path: extra/org.getmonero.Monero.metainfo.xml
