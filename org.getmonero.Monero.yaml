app-id: org.getmonero.Monero
runtime: org.kde.Platform
runtime-version: 5.15-24.08
sdk: org.kde.Sdk
finish-args:
  - --share=network
  - --share=ipc
  # Trying to force Wayland
  - --socket=fallback-x11
  - --socket=wayland
  - --device=all
  - --persist=Monero
  - --persist=.bitmonero
  - --persist=.p2pool

cleanup:
  - /include
  - /etc
  - /share/man
  - /lib/pkgconfig
  - /lib/cmake
  - '*.a'
  - '*.la'

command: monero-wallet-gui
modules:
  - name: monero-gui
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DWITH_DESKTOP_ENTRY=OFF
      - -DWITH_UPDATER=OFF
    build-options:
      arch:
        aarch64:
          config-opts:
            - -DARCH=armv8-a
            - -DBUILD_TAG=linux-armv8
        x86_64:
          config-opts:
            - -DARCH=default
    sources:
      - type: git
        url: https://github.com/monero-project/monero-gui.git
        commit: c89f8eca9155473105519c37e706753214534e2a
      - type: file
        path: extra/org.getmonero.Monero.desktop
      - type: file
        path: extra/org.getmonero.Monero.metainfo.xml
    post-install:
      - install -Dpm644 org.getmonero.Monero.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -Dpm644 org.getmonero.Monero.metainfo.xml $FLATPAK_DEST/share/metainfo/$FLATPAK_ID.metainfo.xml
      - for x in 16 24 32 48 64 96 128 256; do install -Dpm644 images/appicons/${x}x${x}.png $FLATPAK_DEST/share/icons/hicolor/${x}x${x}/apps/$FLATPAK_ID.png; done
    modules:
      - shared-modules/libusb/libusb.json

      - name: boost
        buildsystem: simple
        build-commands:
          - ./bootstrap.sh --prefix=$FLATPAK_DEST --with-libraries=chrono,date_time,filesystem,locale,program_options,regex,serialization,system,thread
          - ./b2 headers
          - ./b2 -j$FLATPAK_BUILDER_N_JOBS install variant=release --layout=system
        sources:
          - type: archive
            url: https://archives.boost.io/release/1.88.0/source/boost_1_88_0.tar.gz
            sha256: 3621533e820dcab1e8012afd583c0c73cf0f77694952b81352bf38c1488f9cb4

      - name: protobuf
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
          - -Dprotobuf_BUILD_TESTS=OFF
        sources:
          - type: archive
            url: https://github.com/protocolbuffers/protobuf/releases/download/v31.1/protobuf-31.1.tar.gz
            sha256: 12bfd76d27b9ac3d65c00966901609e020481b9474ef75c7ff4601ac06fa0b82

      - name: libunbound
        config-opts:
          - --with-libunbound-only
        sources:
          - type: archive
            url: https://nlnetlabs.nl/downloads/unbound/unbound-1.23.1.tar.gz
            sha256: 6a6b117c799d8de3868643397e0fd71591f6d42f4473f598bdb22609ff362590

      - name: libsodium
        sources:
          - type: archive
            url: https://github.com/jedisct1/libsodium/releases/download/1.0.20-RELEASE/libsodium-1.0.20.tar.gz
            sha256: ebb65ef6ca439333c2bb41a0c1990587288da07f6c7fd07cb3a18cc18d30ce19

      - name: hidapi
        buildsystem: cmake-ninja
        config-opts:
          - -DCMAKE_BUILD_TYPE=Release
        sources:
          - type: archive
            url: https://github.com/libusb/hidapi/archive/hidapi-0.15.0.tar.gz
            sha256: 5d84dec684c27b97b921d2f3b73218cb773cf4ea915caee317ac8fc73cef8136

      - name: openpgm
        subdir: openpgm/pgm
        sources:
          - type: archive
            url: https://github.com/steve-o/openpgm/archive/release-5-3-128.tar.gz
            sha256: 8d707ef8dda45f4a7bc91016d7f2fed6a418637185d76c7ab30b306499c6d393
          - type: patch
            path: extra/openpgm.patch

      - name: libzmq
        config-opts:
          - --with-pgm
          - --with-libsodium
          - --disable-Werror
        sources:
          - type: archive
            url: https://github.com/zeromq/libzmq/releases/download/v4.3.5/zeromq-4.3.5.tar.gz
            sha256: 6653ef5910f17954861fe72332e68b03ca6e4d9c7160eb3a8de5a5a913bfab43

  - name: p2pool
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DWITH_LTO=OFF
    sources:
      - type: git
        url: https://github.com/SChernykh/p2pool
        tag: v4.10
        commit: bbee372a01c2761f38600438c71753806a11426e
    post-install:
      - install -Dm755 p2pool $FLATPAK_DEST/bin/p2pool
    modules:
      - name: libgss
        sources:
          - type: archive
            url: https://ftp.gnu.org/gnu/gss/gss-1.0.4.tar.gz
            sha256: ecceabdef4cae3fce7218b2ecb83eb4227dba44b53b61b8c2b2e88ae02419c73

      - name: libuv
        buildsystem: cmake-ninja
        sources:
          - type: archive
            url: https://github.com/libuv/libuv/archive/v1.51.0.tar.gz
            sha256: 27e55cf7083913bfb6826ca78cde9de7647cded648d35f24163f2d31bb9f51cd

